# R9-S2 설계 노트 – CS LLM 연동 및 엔진 정책

## 1. Local LLM 엔진 버전 정의

- `engine_mode = local-llm`의 R9-S2 구현은 **온디바이스 LLM Stub(v0)** 이다.
- R10 이후 실제 온디바이스 모델을 연결하는 버전을 **local-llm-v1**로 구분한다.
- Stub 응답과 실제 모델 응답은 다음 메타 정보로 구분한다.
  - Stub: `engine = "local-llm-v1"`, `meta.stub = true`
  - 실제 모델: `engine = "local-llm-v1"`, `meta.stub = false` (또는 존재하지 않음)

## 2. Remote LLM 모드 원칙

- `engine_mode = remote` 모드는 R9-S2에서는 타입/플래그 정의까지만 포함하고, 실제 구현은 R10 이후 단계에서 진행한다.
- Remote 모드 구현 시 원칙:
  - HUD/Web 클라이언트는 외부 LLM에 직접 HTTP 요청을 보내지 않는다.
  - 항상 **사내 게이트웨이(BFF/OS Gateway)** 를 통해 LLM과 통신한다.
  - 게이트웨이는 API 키, 엔드포인트, 로깅/마스킹, 테넌트/권한 정책을 담당한다.

## 3. 도메인별 LLM 타입/엔진 구조

- CS 도메인:
  - `CsLLMContext`, `CsLLMResponse`, `CsResponseSuggestion`, `CsSuggestContext` 타입으로 구성.
  - HR/법무/보안/반도체/조선/SW/개인정보 도메인도 동일한 패턴으로 확장할 수 있도록 설계한다.
- R10 이후 리팩토링 메모:
  - `DomainLLMContext<TDomain>`, `DomainLLMResponse<TDomain>` 같은 제너릭 인터페이스 도입 검토.
  - 도메인별 LLM 서비스(csLLMService, accountingLLMService 등)를 `DomainLLMService` 인터페이스로 추상화.
  - SuggestEngine 내부 도메인 분기도 레지스트리/맵 기반 구조로 전환.

## 4. BFF 헤더/권한 정책 (CS)

- CS 도메인 BFF 라우트(`/v1/cs/*`)도 회계(`/v1/accounting/*`)와 동일한 헤더 정책을 따른다.
  - `X-Tenant`
  - `X-User-Id`
  - `X-User-Role`
- 모든 CS 라우트는 `requireTenantAuth`, `requireRole('operator')` 등 공통 가드를 사용하여
  OS 정책 브리지를 강제한다.

### R10 이후 리팩토링 메모 – Domain LLM 추상화

- 현재 SuggestDomain은 'accounting' | 'cs' 기준이며,
  HR/법무/보안/반도체/조선/SW/개인정보 도메인이 추가될 예정이다.
- R10 이후에는 다음 방향의 리팩토링을 고려한다.
  1) DomainLLMContext<TDomain> / DomainLLMResponse<TDomain> 제너릭 인터페이스 정의
  2) 도메인별 LLM 서비스(csLLMService, accountingLLMService, hrLLMService 등)를
     공통 DomainLLMService 인터페이스로 추상화
  3) SuggestEngine 내부에서 도메인별 switch문 대신,
     "도메인 → 핸들러" 매핑 테이블(레지스트리) 기반 구조로 전환

