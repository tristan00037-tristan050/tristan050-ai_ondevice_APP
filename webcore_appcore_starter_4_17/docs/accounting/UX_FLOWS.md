# 회계 UX 플로우

R6 회계 확장 - 사용자 플로우 정의

## 정상 플로우 (Happy Path)

### 플로우 1: 캡처 → 분개 → 승인

```
1. 캡처 (OCR)
   └─> 영수증 이미지 업로드
   └─> OCR 엔진으로 라인아이템 추출
   └─> 추출 결과 확인

2. 분개 추천
   └─> POST /v1/accounting/postings/suggest
   └─> 신뢰도/근거 표시
   └─> 사용자 수정 (필요 시)

3. 분개 확정
   └─> POST /v1/accounting/postings
   └─> Idempotency-Key 헤더 포함
   └─> 분개 생성 완료

4. 승인 요청
   └─> POST /v1/accounting/approvals
   └─> 승인자 지정
   └─> 승인 대기 상태

5. 승인 처리
   └─> 승인자 승인/거부
   └─> GET /v1/accounting/approvals/{id}
   └─> 최종 확정
```

### 플로우 2: 일괄 처리

```
1. 여러 영수증 일괄 업로드
2. 각각 분개 추천
3. 일괄 승인 요청
4. 승인자 일괄 승인
```

---

## 예외 플로우

### 예외 1: 정책 위반

**시나리오**: 계정 불일치, 한도 초과 등

```
1. 분개 추천 시도
2. 정책 검증 실패
   └─> 에러 메시지: "계정 코드 불일치"
   └─> 상태: "needs_review"
3. 수동 검토 큐로 이동
4. 관리자 검토 후 수정/승인
```

**UX 처리**:
- HUD에 정책 위반 경고 표시
- 수동 검토 큐에 항목 추가
- 관리자 알림 (선택사항)

---

### 예외 2: OCR 실패 / 불완전 데이터

**시나리오**: OCR 품질 저하, 필수 필드 누락

```
1. OCR 실행
2. 품질 검증 실패
   └─> 신뢰도 < 임계값
   └─> 필수 필드 누락
3. 상태: "pending_info"
4. 사용자 수동 입력 요청
5. 수정 후 재처리
```

**UX 처리**:
- "보류(Pending Info)" 상태 표시
- 수동 입력 UI 제공
- 재처리 버튼

---

### 예외 3: 네트워크 오류

**시나리오**: 오프라인 상태에서 분개 생성 시도

```
1. 분개 생성 시도
2. 네트워크 오류 감지
3. 오프라인 큐에 저장
4. 네트워크 복구 시 자동 재시도
   └─> 지수 백오프 + 지터
5. 재시도 성공 시 정상 처리
```

**UX 처리**:
- 오프라인 큐 상태 표시
- 재시도 진행 상황 표시
- 실패 시 수동 재시도 옵션

---

### 예외 4: 승인 거부

**시나리오**: 승인자가 분개를 거부

```
1. 승인 요청
2. 승인자 검토
3. 승인 거부
   └─> status: "rejected"
   └─> 거부 사유 입력
4. 원래 요청자에게 알림
5. 수정 후 재요청 또는 취소
```

**UX 처리**:
- 거부 알림 표시
- 거부 사유 확인
- 수정/재요청 또는 취소 옵션

---

## 상태 다이어그램

```
[캡처] → [OCR 진행] → [라인아이템 추출]
                              ↓
                    [분개 추천] → [사용자 수정]
                              ↓
                    [정책 검증]
                    /          \
              [통과]          [실패]
                 |              |
        [분개 확정]      [수동 검토 큐]
                 |              |
        [승인 요청]      [관리자 검토]
                 |              |
        [승인 대기]      [수정/승인]
                 |
        [승인/거부]
        /         \
   [승인]      [거부]
      |            |
[최종 확정]  [재요청/취소]
```

---

## HUD 표시 요소

### 분개 추천 화면

- **신뢰도**: 0.0 ~ 1.0 (색상 코딩)
  - 높음 (≥0.8): 초록색
  - 중간 (0.5~0.8): 노란색
  - 낮음 (<0.5): 빨간색

- **추천 근거**: 텍스트 표시
- **정책 위반 경고**: 빨간색 배지
- **수정 버튼**: 분개 수정 UI

### 승인 화면

- **승인 상태**: pending/approved/rejected/needs_review
- **승인 단계**: 다단계 승인 진행 상황
- **승인자 정보**: 현재 승인자/다음 승인자

### 오프라인 큐 화면

- **대기 중인 항목 수**
- **재시도 진행 상황**
- **실패 항목**: 수동 재시도 옵션

---

## 참고

- 모든 플로우는 R5d~5.4 기준선을 준수:
  - 서버사이드 처리
  - 테넌트 격리
  - 오프라인 큐/재시도/지터
  - ETag/304 캐싱


