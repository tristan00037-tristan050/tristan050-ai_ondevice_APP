name: CI Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  lint-and-typecheck:
    name: Lint and TypeScript Check
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: webcore_appcore_starter_4_17
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: webcore_appcore_starter_4_17/package-lock.json
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run ESLint
        run: npm run lint --workspaces
      
      - name: Run TypeScript check
        run: npm run type-check --workspaces

  schema-validation:
    name: Schema Validation
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: webcore_appcore_starter_4_17
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: webcore_appcore_starter_4_17/package-lock.json
      
      - name: Install dependencies
        run: npm ci
      
      - name: Validate schemas
        run: npm run validate:all
      
      - name: Validate accounting schemas
        run: npm run ci:validate:accounting || echo "⚠️ Accounting schemas validation skipped (no test data)"

  openapi-sync:
    name: OpenAPI Type Sync
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: webcore_appcore_starter_4_17
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: webcore_appcore_starter_4_17/package-lock.json
      
      - name: Install dependencies
        run: npm ci
      
      - name: Generate OpenAPI types
        run: npm run ci:gen-types
      
      - name: Generate Accounting OpenAPI types
        run: npm run ci:gen-types:accounting || echo "⚠️ Accounting types generation skipped"
      
      - name: Check OpenAPI sync
        run: npm run ci:check-openapi

  security-checks:
    name: Security and Compliance Checks
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: webcore_appcore_starter_4_17
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: webcore_appcore_starter_4_17/package-lock.json
      
      - name: Install dependencies
        run: npm ci
      
      - name: Check roles guard
        run: npm run ci:check-roles
      
      - name: Check client-side filter
        run: npm run ci:check-client-filter

  schema-and-types:
    name: Schema and Type Validation
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: webcore_appcore_starter_4_17
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: webcore_appcore_starter_4_17/package-lock.json
      
      - name: Install dependencies
        run: npm ci
      
      - name: Generate accounting types
        run: npm run ci:gen-types:accounting
      
      - name: Validate accounting schemas
        run: npm run ci:validate:accounting || echo "⚠️ Accounting schemas validation skipped (no test data)"

  build:
    name: Build All Packages
    runs-on: ubuntu-latest
    needs: [lint-and-typecheck, schema-validation]
    defaults:
      run:
        working-directory: webcore_appcore_starter_4_17
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: webcore_appcore_starter_4_17/package-lock.json
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build Collector
        run: npm run build --workspace=@appcore/collector-node-ts
      
      - name: Build BFF
        run: npm run build --workspace=@appcore/bff-node-ts
      
      - name: Build Ops Console
        run: npm run build --workspace=@appcore/ops-console

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: [build]
    defaults:
      run:
        working-directory: webcore_appcore_starter_4_17
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: webcore_appcore_starter_4_17/package-lock.json
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run tests
        run: npm test --workspaces --if-present
      
      - name: Run accounting smoke tests
        run: npm run smoke:accounting || echo "⚠️ Accounting smoke tests skipped (service not running)"
        continue-on-error: true

  golden-set-guard:
    name: Golden Set Guard
    runs-on: ubuntu-latest
    needs: [schema-and-types]
    defaults:
      run:
        working-directory: webcore_appcore_starter_4_17
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: webcore_appcore_starter_4_17/package-lock.json
      
      - name: Install dependencies
        run: npm ci
      
      - name: Golden set size / PII / format
        run: npm run ci:gold-size
      
      - name: Synthetic ratio gate (≤ 30%)
        env:
          MAX_SYN_RATIO: "0.30"
        run: npm run ci:gold-synthetic

  bench-accounting:
    name: Accounting Accuracy Benchmark
    runs-on: ubuntu-latest
    needs: [golden-set-guard]
    defaults:
      run:
        working-directory: webcore_appcore_starter_4_17
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: webcore_appcore_starter_4_17/package-lock.json
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build service-core-accounting
        run: npm run build --workspace=@appcore/service-core-accounting
      
      - name: Generate accounting types
        run: npm run ci:gen-types:accounting
      
      - name: Validate accounting schemas
        run: npm run ci:validate:accounting || echo "⚠️ Accounting schemas validation skipped (no test data)"
      
      - name: Accuracy gate
        run: npm run ci:gate:accuracy
        env:
          MIN_GOLD: "50"
          THRESH_TOP1: "0.70"
          THRESH_TOP5: "0.85"
      
      - name: Bench (report)
        run: npm run measure:accuracy

  e2e-accounting:
    name: Accounting E2E Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: webcore_appcore_starter_4_17
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: webcore_appcore_starter_4_17/package-lock.json
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build service-core-accounting
        run: npm run build --workspace=@appcore/service-core-accounting
      
      - name: Build bff-accounting
        run: npm run build --workspace=@appcore/bff-accounting
      
      - name: Install bff-accounting dependencies
        run: npm install --prefix packages/bff-accounting
      
      - name: Start BFF server
        run: |
          npm --prefix packages/bff-accounting run start &
          sleep 2
          for i in {1..30}; do
            curl -fsS http://localhost:8081/health && break
            sleep 1
          done
      
      - name: Run E2E tests
        run: BFF_URL=http://localhost:8081 API_KEY=collector-key TENANT_ID=default npm run test:e2e:accounting
      
      - name: Stop BFF server
        run: pkill -f "bff-accounting" || true

  no-artifacts-committed:
    name: Ensure no deps/build artifacts in git
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Ensure no deps/build artifacts in git
        run: |
          if git ls-files | grep -E '(^|/)(node_modules|dist)(/|$)'; then
            echo "❌ Found tracked node_modules/dist files"
            echo "Files:"
            git ls-files | grep -E '(^|/)(node_modules|dist)(/|$)'
            exit 1
          else
            echo "✅ No build artifacts or dependencies tracked in git"
          fi

  e2e-bff-accounting:
    name: BFF Accounting E2E Smoke
    runs-on: ubuntu-latest
    needs: [golden-set-guard, bench-accounting]
    timeout-minutes: 10
    defaults:
      run:
        working-directory: webcore_appcore_starter_4_17
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: webcore_appcore_starter_4_17/package-lock.json
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build service-core-accounting
        run: npm run build --workspace=@appcore/service-core-accounting
      
      - name: Build bff-accounting
        run: npm run build --workspace=@appcore/bff-accounting
      
      - name: Install bff-accounting dependencies
        run: npm install --prefix packages/bff-accounting
      
      - name: Start BFF server
        run: |
          npm --prefix packages/bff-accounting run start &
          sleep 3
          for i in {1..30}; do
            curl -fsS http://localhost:8081/health && break
            sleep 1
          done
      
      - name: E2E Suggest
        env:
          BFF_URL: http://localhost:8081
          API_KEY: collector-key
          TENANT_ID: default
        run: npm run test:e2e:accounting:bff
      
      - name: E2E Approvals
        env:
          BFF_URL: http://localhost:8081
          API_KEY: collector-key:operator
          TENANT_ID: default
        run: npm run test:e2e:accounting:approvals
      
      - name: E2E Exports
        env:
          BFF_URL: http://localhost:8081
          API_KEY: collector-key:auditor
          TENANT_ID: default
        run: npm run test:e2e:accounting:exports
      
      - name: E2E Exports (negative cases)
        env:
          BFF_URL: http://localhost:8081
          TENANT_ID: default
        run: npm run test:e2e:accounting:exports:neg
      
      - name: E2E Reconciliation
        env:
          BFF_URL: http://localhost:8081
          API_KEY: collector-key:operator
          TENANT_ID: default
        run: npm run test:e2e:accounting:recon
      
      - name: Stop BFF server
        run: pkill -f "bff-accounting" || true

  no-artifacts-committed:
    name: Ensure no deps/build artifacts in git
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Ensure no deps/build artifacts in git
        run: |
          if git ls-files | grep -E '(^|/)(node_modules|dist)(/|$)'; then
            echo "❌ Found tracked node_modules/dist files"
            echo "Files:"
            git ls-files | grep -E '(^|/)(node_modules|dist)(/|$)'
            exit 1
          else
            echo "✅ No build artifacts or dependencies tracked in git"
          fi

  persistence-e2e:
    name: Persistence E2E (PostgreSQL)
    needs: [e2e-bff-accounting]
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_DB: app
          POSTGRES_USER: app
          POSTGRES_PASSWORD: app
        ports:
          - "5432:5432"
        options: >-
          --health-cmd="pg_isready -U app -d app"
          --health-interval=5s
          --health-timeout=5s
          --health-retries=20
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: webcore_appcore_starter_4_17/package-lock.json
      
        run: npm ci
      
      - name: DB migrate
        env:
          DATABASE_URL: postgres://app:app@localhost:5432/app
        run: npm run db:migrate
      
      - name: Start BFF (PG)
        env:
          DATABASE_URL: postgres://app:app@localhost:5432/app
          USE_PG: "1"
          EXPORT_SIGN_SECRET: ci-secret
        run: |
          cd packages/bff-accounting
          npm i
          npm run build
          node --enable-source-maps dist/index.js &
          sleep 3
          cd ../..
      
      - name: E2E persistence (API→DB)
        env:
          BFF_URL: http://localhost:8081
          TENANT_ID: default
          API_KEY_AUD: collector-key:auditor
          API_KEY_OP: collector-key:operator
          DATABASE_URL: postgres://app:app@localhost:5432/app
        run: npm run test:e2e:accounting:persistence
      
      - name: Stop BFF server
        run: pkill -f "bff-accounting" || true

  no-artifacts-committed:
    name: Ensure no deps/build artifacts in git
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Ensure no deps/build artifacts in git
        run: |
          if git ls-files | grep -E '(^|/)(node_modules|dist)(/|$)'; then
            echo "❌ Found tracked node_modules/dist files"
            echo "Files:"
            git ls-files | grep -E '(^|/)(node_modules|dist)(/|$)'
            exit 1
          else
            echo "✅ No build artifacts or dependencies tracked in git"
          fi

  gate-os-integration:
    name: OS Integration Gate
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: webcore_appcore_starter_4_17
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_DB: app
          POSTGRES_USER: app
          POSTGRES_PASSWORD: app
        ports:
          - "5432:5432"
        options: >-
          --health-cmd="pg_isready -U app -d app"
          --health-interval=5s
          --health-timeout=5s
          --health-retries=20
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: webcore_appcore_starter_4_17/package-lock.json
        run: npm ci
      - name: Build packages
        run: npm run build:packages
      - name: DB migrate
        env:
          DATABASE_URL: postgres://app:app@localhost:5432/app
        run: npm run db:migrate
      - name: Start BFF
        env:
          DATABASE_URL: postgres://app:app@localhost:5432/app
          USE_PG: "1"
          EXPORT_SIGN_SECRET: ci-secret
          OS_POLICY_BRIDGE_ENFORCE: "true"
          OS_ROLE_MAP_JSON: '{"viewer":"viewer","operator":"operator","auditor":"auditor","admin":"admin"}'
        run: |
          cd packages/bff-accounting
          npm i
          npm run build
          node --enable-source-maps dist/index.js &
          sleep 3
          cd ../..
      - name: Test OS policy bridge (403 on invalid role)
        run: |
          response=$(curl -s -w "\n%{http_code}" -H 'X-Tenant: default' -H 'X-User-Id: u1' -H 'X-User-Role: unknown' http://localhost:8081/v1/accounting/audit)
          http_code=$(echo "$response" | tail -1)
          body=$(echo "$response" | head -1)
          if [ "$http_code" != "403" ]; then
            echo "❌ Expected 403, got $http_code"
            exit 1
          fi
          if ! echo "$body" | grep -q "OS_POLICY_DENY"; then
            echo "❌ Expected error_code=OS_POLICY_DENY"
            exit 1
          fi
          echo "✅ OS policy bridge correctly rejects invalid role"
      - name: Test audit API (auditor access)
        run: |
          response=$(curl -s -w "\n%{http_code}" -H 'X-Tenant: default' -H 'X-User-Id: u2' -H 'X-User-Role: auditor' 'http://localhost:8081/v1/accounting/audit?page=1&page_size=20')
          http_code=$(echo "$response" | tail -1)
          if [ "$http_code" != "200" ]; then
            echo "❌ Expected 200, got $http_code"
            exit 1
          fi
          echo "✅ Audit API accessible to auditor"
      - name: Test audit API (viewer denied)
        run: |
          response=$(curl -s -w "\n%{http_code}" -H 'X-Tenant: default' -H 'X-User-Id: u3' -H 'X-User-Role: viewer' 'http://localhost:8081/v1/accounting/audit')
          http_code=$(echo "$response" | tail -1)
          if [ "$http_code" != "403" ]; then
            echo "❌ Expected 403 for viewer, got $http_code"
            exit 1
          fi
          echo "✅ Viewer correctly denied access to audit API"
      - name: Test OS summary API
        run: |
          response=$(curl -s -w "\n%{http_code}" -H 'X-Tenant: default' -H 'X-User-Id: u4' -H 'X-User-Role: operator' http://localhost:8081/v1/accounting/os/summary)
          http_code=$(echo "$response" | tail -1)
          body=$(echo "$response" | head -1)
          if [ "$http_code" != "200" ]; then
            echo "❌ Expected 200, got $http_code"
            exit 1
          fi
          if ! echo "$body" | grep -q "approvals"; then
            echo "❌ Missing approvals field in summary"
            exit 1
          fi
          if ! echo "$body" | grep -q "exports"; then
            echo "❌ Missing exports field in summary"
            exit 1
          fi
          if ! echo "$body" | grep -q "recon"; then
            echo "❌ Missing recon field in summary"
            exit 1
          fi
          if ! echo "$body" | grep -q "errors"; then
            echo "❌ Missing errors field in summary"
            exit 1
          fi
          echo "✅ OS summary API returns expected fields"
      - name: Stop BFF
        run: pkill -f "bff-accounting" || true
