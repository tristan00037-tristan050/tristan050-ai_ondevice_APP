name: CI Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  lint-and-typecheck:
    name: Lint and TypeScript Check
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: webcore_appcore_starter_4_17
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run ESLint
        run: npm run lint --workspaces
      
      - name: Run TypeScript check
        run: npm run type-check --workspaces

  schema-validation:
    name: Schema Validation
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: webcore_appcore_starter_4_17
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Validate schemas
        run: npm run validate:all
      
      - name: Validate accounting schemas
        run: npm run ci:validate:accounting || echo "⚠️ Accounting schemas validation skipped (no test data)"

  openapi-sync:
    name: OpenAPI Type Sync
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: webcore_appcore_starter_4_17
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Generate OpenAPI types
        run: npm run ci:gen-types
      
      - name: Generate Accounting OpenAPI types
        run: npm run ci:gen-types:accounting || echo "⚠️ Accounting types generation skipped"
      
      - name: Check OpenAPI sync
        run: npm run ci:check-openapi

  security-checks:
    name: Security and Compliance Checks
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: webcore_appcore_starter_4_17
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Check roles guard
        run: npm run ci:check-roles
      
      - name: Check client-side filter
        run: npm run ci:check-client-filter

  schema-and-types:
    name: Schema and Type Validation
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: webcore_appcore_starter_4_17
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Generate accounting types
        run: npm run ci:gen-types:accounting
      
      - name: Validate accounting schemas
        run: npm run ci:validate:accounting || echo "⚠️ Accounting schemas validation skipped (no test data)"

  build:
    name: Build All Packages
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: webcore_appcore_starter_4_17
    needs: [lint-and-typecheck, schema-validation]
    defaults:
      run:
        working-directory: webcore_appcore_starter_4_17
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: npm ci
      
      - name: S7 Always On - preflight
        run: |
          set -euo pipefail
          cd "$(git rev-parse --show-toplevel)/webcore_appcore_starter_4_17"
          bash scripts/ops/verify_s7_always_on.sh
      
      - name: S7 Phase 0 - retriever quality meta-only report
        run: |
          set -euo pipefail
          cd "$(git rev-parse --show-toplevel)/webcore_appcore_starter_4_17"
          bash scripts/ops/verify_retriever_quality.sh
          test -f docs/ops/r10-s7-retriever-quality-phase0-report.json
      
      - name: Verify S7 Phase 0 report meta-only (before upload)
        run: |
          set -euo pipefail
          cd "$(git rev-parse --show-toplevel)/webcore_appcore_starter_4_17"
          REPORT="docs/ops/r10-s7-retriever-quality-phase0-report.json"
          test -f "$REPORT" || (echo "FAIL: report not found" && exit 1)
          # Query key must be absent
          if rg -n '"query"' "$REPORT" >/dev/null 2>&1; then
            echo "FAIL: report contains query key (meta-only violation)"
            rg -n '"query"' "$REPORT"
            exit 1
          fi
          # Run meta-only verifier
          bash scripts/ops/verify_rag_meta_only.sh
          echo "OK: report is meta-only compliant"
      
      - name: Upload S7 Phase 0 report artifact
        uses: actions/upload-artifact@v4
        with:
          name: s7-retriever-quality-phase0-report
          path: webcore_appcore_starter_4_17/docs/ops/r10-s7-retriever-quality-phase0-report.json
      
      - name: Build Collector
        run: npm run build --workspace=@appcore/collector-node-ts
      
      - name: Build BFF
        run: npm run build --workspace=@appcore/bff-node-ts
      
      - name: Build Ops Console
        run: npm run build --workspace=@appcore/ops-console
      
      # ✅ F) CI 게이트 승격: build_info 생성/검증 + dist require( 0 + healthz anchor 무결성
      - name: Build bff-accounting (with build_info)
        run: npm run build --workspace=@appcore/bff-accounting
      
      - name: Verify build_info.json exists
        run: |
          if [ ! -f packages/bff-accounting/dist/build_info.json ]; then
            echo "❌ build_info.json not found"
            exit 1
          fi
          echo "✅ build_info.json exists"
          head -5 packages/bff-accounting/dist/build_info.json
      
      - name: Verify build_info.json format (40-hex buildSha)
        run: |
          BUILD_SHA=$(jq -r '.buildSha // empty' packages/bff-accounting/dist/build_info.json)
          if [ -z "$BUILD_SHA" ] || [ "$BUILD_SHA" = "unknown" ]; then
            echo "❌ buildSha is missing or unknown"
            exit 1
          fi
          if [ ${#BUILD_SHA} -ne 40 ]; then
            echo "❌ buildSha length is ${#BUILD_SHA} (expected 40)"
            exit 1
          fi
          if ! echo "$BUILD_SHA" | grep -qE '^[0-9a-f]{40}$'; then
            echo "❌ buildSha is not 40-hex: $BUILD_SHA"
            exit 1
          fi
          echo "✅ buildSha is valid 40-hex: ${BUILD_SHA:0:7}..."
      
      - name: Verify dist require( 0 (ESM-only)
        run: |
          # rg가 2를 반환하는 "미발견"을 정상으로 취급
          if rg -n "require\\(" packages/bff-accounting/dist 2>/dev/null; then
            echo "❌ Found require( in dist (ESM-only required)"
            exit 1
          else
            EXIT_CODE=$?
            if [ $EXIT_CODE -eq 0 ]; then
              echo "❌ Unexpected rg exit code: $EXIT_CODE"
              exit 1
            elif [ $EXIT_CODE -eq 2 ]; then
              echo "✅ No require( found in dist (ESM-only)"
            else
              echo "⚠️ rg exit code: $EXIT_CODE (treating as OK)"
            fi
          fi
      
      - name: Verify buildSha matches HEAD (CI build integrity)
        run: |
          BUILD_SHA=$(jq -r '.buildSha' packages/bff-accounting/dist/build_info.json)
          GIT_HEAD=$(git rev-parse HEAD)
          if [ "$BUILD_SHA" != "$GIT_HEAD" ]; then
            echo "❌ buildSha mismatch: build_info=$BUILD_SHA, git HEAD=$GIT_HEAD"
            exit 1
          fi
          echo "✅ buildSha matches git HEAD: ${BUILD_SHA:0:7}..."
      
      # ✅ CI Hard Gate: verify_build_anchor.sh 실행 (필수 PASS)
      - name: Verify build anchor (scripts/ops/verify_build_anchor.sh)
        run: |
          # BFF 기동 (포트 충돌 방지)
          PORT=8082
          cd packages/bff-accounting
          node --enable-source-maps dist/index.js &
          BFF_PID=$!
          sleep 3
          cd ../..
          
          # verify 실행
          BASE_URL="http://localhost:${PORT}" bash scripts/ops/verify_build_anchor.sh
          
          # 정리
          kill $BFF_PID 2>/dev/null || true
      
      # ✅ CI Hard Gate: destructive_build_anchor_should_fail.sh 실행 (필수 PASS)
      - name: Destructive test (build anchor tamper should fail)
        run: |
          # BFF 기동 (포트 충돌 방지)
          PORT=8082
          cd packages/bff-accounting
          node --enable-source-maps dist/index.js &
          BFF_PID=$!
          sleep 3
          cd ../..
          
          # destructive 테스트 실행 (스크립트 자체는 PASS로 종료)
          BASE_URL="http://localhost:${PORT}" bash scripts/ops/destructive_build_anchor_should_fail.sh
          
          # 정리
          kill $BFF_PID 2>/dev/null || true

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: webcore_appcore_starter_4_17
    needs: [build]
    defaults:
      run:
        working-directory: webcore_appcore_starter_4_17
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run tests
        run: npm test --workspaces --if-present
      
      - name: Run accounting smoke tests
        run: npm run smoke:accounting || echo "⚠️ Accounting smoke tests skipped (service not running)"
        continue-on-error: true

  golden-set-guard:
    name: Golden Set Guard
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: webcore_appcore_starter_4_17
    needs: [schema-and-types]
    defaults:
      run:
        working-directory: webcore_appcore_starter_4_17
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Golden set size / PII / format
        run: npm run ci:gold-size
      
      - name: Synthetic ratio gate (≤ 30%)
        env:
          MAX_SYN_RATIO: "0.30"
        run: npm run ci:gold-synthetic

  bench-accounting:
    name: Accounting Accuracy Benchmark
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: webcore_appcore_starter_4_17
    needs: [golden-set-guard]
    defaults:
      run:
        working-directory: webcore_appcore_starter_4_17
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build service-core-accounting
        run: npm run build --workspace=@appcore/service-core-accounting
      
      - name: Generate accounting types
        run: npm run ci:gen-types:accounting
      
      - name: Validate accounting schemas
        run: npm run ci:validate:accounting || echo "⚠️ Accounting schemas validation skipped (no test data)"
      
      - name: Accuracy gate
        run: npm run ci:gate:accuracy
        env:
          MIN_GOLD: "50"
          THRESH_TOP1: "0.70"
          THRESH_TOP5: "0.85"
      
      - name: Bench (report)
        run: npm run measure:accuracy

  e2e-accounting:
    name: Accounting E2E Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: webcore_appcore_starter_4_17
    needs: [bench-accounting]
    defaults:
      run:
        working-directory: webcore_appcore_starter_4_17
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build service-core-accounting
        run: npm run build --workspace=@appcore/service-core-accounting
      
      - name: Build bff-accounting
        run: npm run build --workspace=@appcore/bff-accounting
      
      - name: Install bff-accounting dependencies
        run: npm install --prefix packages/bff-accounting
      
      - name: Start BFF server
        run: |
          npm --prefix packages/bff-accounting run start &
          sleep 2
          for i in {1..30}; do
            curl -fsS http://localhost:8081/health && break
            sleep 1
          done
      
      - name: Run E2E tests
        run: BFF_URL=http://localhost:8081 API_KEY=collector-key TENANT_ID=default npm run test:e2e:accounting
      
      - name: Stop BFF server
        run: pkill -f "bff-accounting" || true

  no-artifacts-committed:
    defaults:
      run:
        working-directory: webcore_appcore_starter_4_17
    name: Ensure no deps/build artifacts in git
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: webcore_appcore_starter_4_17
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Ensure no deps/build artifacts in git
        run: |
          if git ls-files | grep -E '(^|/)(node_modules|dist)(/|$)'; then
            echo "❌ Found tracked node_modules/dist files"
            echo "Files:"
            git ls-files | grep -E '(^|/)(node_modules|dist)(/|$)'
            exit 1
          else
            echo "✅ No build artifacts or dependencies tracked in git"
          fi

  e2e-bff-accounting:
    name: BFF Accounting E2E Smoke
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: webcore_appcore_starter_4_17
    needs: [golden-set-guard, bench-accounting]
    timeout-minutes: 10
    defaults:
      run:
        working-directory: webcore_appcore_starter_4_17
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build service-core-accounting
        run: npm run build --workspace=@appcore/service-core-accounting
      
      - name: Build bff-accounting
        run: npm run build --workspace=@appcore/bff-accounting
      
      # ✅ F) CI 게이트: build_info 생성/검증
      - name: Verify build_info.json exists and format
        run: |
          if [ ! -f packages/bff-accounting/dist/build_info.json ]; then
            echo "❌ build_info.json not found"
            exit 1
          fi
          BUILD_SHA=$(jq -r '.buildSha // empty' packages/bff-accounting/dist/build_info.json)
          if [ -z "$BUILD_SHA" ] || [ "$BUILD_SHA" = "unknown" ] || [ ${#BUILD_SHA} -ne 40 ] || ! echo "$BUILD_SHA" | grep -qE '^[0-9a-f]{40}$'; then
            echo "❌ build_info.json buildSha is invalid"
            exit 1
          fi
          echo "✅ build_info.json valid: ${BUILD_SHA:0:7}..."
      
      # ✅ F) CI 게이트: dist require( 0 (ESM-only)
      - name: Verify dist require( 0
        run: |
          # rg exit code: 0=발견, 1=에러, 2=미발견
          if rg -n "require\\(" packages/bff-accounting/dist 2>/dev/null; then
            echo "❌ Found require( in dist (ESM-only required)"
            exit 1
          else
            EXIT_CODE=$?
            if [ $EXIT_CODE -eq 2 ]; then
              echo "✅ No require( found in dist (ESM-only)"
            elif [ $EXIT_CODE -eq 0 ]; then
              echo "❌ Unexpected: rg returned 0 but no output"
              exit 1
            else
              echo "⚠️ rg exit code: $EXIT_CODE (treating as OK)"
            fi
          fi
      
      - name: Install bff-accounting dependencies
        run: npm install --prefix packages/bff-accounting
      
      - name: Start BFF server
        run: |
          npm --prefix packages/bff-accounting run start &
          sleep 3
          for i in {1..30}; do
            curl -fsS http://localhost:8081/health && break
            sleep 1
          done
      
      # ✅ CI Hard Gate: verify_build_anchor.sh 실행 (필수 PASS)
      - name: Verify build anchor (scripts/ops/verify_build_anchor.sh)
        run: |
          BASE_URL="http://localhost:8081" bash scripts/ops/verify_build_anchor.sh
      
      # ✅ CI Hard Gate: destructive_build_anchor_should_fail.sh 실행 (필수 PASS)
      - name: Destructive test (build anchor tamper should fail)
        run: |
          BASE_URL="http://localhost:8081" bash scripts/ops/destructive_build_anchor_should_fail.sh
      
      - name: S7 Phase 1 - Regression Gate (baseline compare)
        run: |
          set -euo pipefail
          cd "$(git rev-parse --show-toplevel)/webcore_appcore_starter_4_17"
          bash scripts/ops/verify_retriever_regression_gate.sh

      - name: Upload S7 Phase 1 report artifact
        uses: actions/upload-artifact@v4
        with:
          name: s7-retriever-quality-phase1-report
          path: webcore_appcore_starter_4_17/docs/ops/r10-s7-retriever-quality-phase1-report.json

      - name: S7 Always On - post-scan
        run: |
          set -euo pipefail
          cd "$(git rev-parse --show-toplevel)/webcore_appcore_starter_4_17"
          bash scripts/ops/verify_s7_always_on.sh
      
      - name: E2E Suggest
        env:
          BFF_URL: http://localhost:8081
          API_KEY: collector-key
          TENANT_ID: default
        run: npm run test:e2e:accounting:bff
      
      - name: E2E Approvals
        env:
          BFF_URL: http://localhost:8081
          API_KEY: collector-key:operator
          TENANT_ID: default
        run: npm run test:e2e:accounting:approvals
      
      - name: E2E Exports
        env:
          BFF_URL: http://localhost:8081
          API_KEY: collector-key:auditor
          TENANT_ID: default
        run: npm run test:e2e:accounting:exports
      
      - name: E2E Exports (negative cases)
        env:
          BFF_URL: http://localhost:8081
          TENANT_ID: default
        run: npm run test:e2e:accounting:exports:neg
      
      - name: E2E Reconciliation
        env:
          BFF_URL: http://localhost:8081
          API_KEY: collector-key:operator
          TENANT_ID: default
        run: npm run test:e2e:accounting:recon
      
      - name: Stop BFF server
        run: pkill -f "bff-accounting" || true

  no-artifacts-committed:
    defaults:
      run:
        working-directory: webcore_appcore_starter_4_17
    name: Ensure no deps/build artifacts in git
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: webcore_appcore_starter_4_17
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Ensure no deps/build artifacts in git
        run: |
          if git ls-files | grep -E '(^|/)(node_modules|dist)(/|$)'; then
            echo "❌ Found tracked node_modules/dist files"
            echo "Files:"
            git ls-files | grep -E '(^|/)(node_modules|dist)(/|$)'
            exit 1
          else
            echo "✅ No build artifacts or dependencies tracked in git"
          fi

  persistence-e2e:
    defaults:
      run:
        working-directory: webcore_appcore_starter_4_17
    name: Persistence E2E (PostgreSQL)
    needs: [e2e-bff-accounting]
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: webcore_appcore_starter_4_17
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_DB: app
          POSTGRES_USER: app
          POSTGRES_PASSWORD: app
        ports:
          - "5432:5432"
        options: >-
          --health-cmd="pg_isready -U app -d app"
          --health-interval=5s
          --health-timeout=5s
          --health-retries=20
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        working-directory: webcore_appcore_starter_4_17
        run: npm ci
      
      - name: DB migrate
        working-directory: webcore_appcore_starter_4_17
        env:
          DATABASE_URL: postgres://app:app@localhost:5432/app
        run: npm run db:migrate
      
      - name: Start BFF (PG)
        working-directory: webcore_appcore_starter_4_17
        env:
          DATABASE_URL: postgres://app:app@localhost:5432/app
          USE_PG: "1"
          EXPORT_SIGN_SECRET: ci-secret
        run: |
          cd packages/bff-accounting
          npm i
          npm run build
          node --enable-source-maps dist/index.js &
          sleep 3
          cd ../..
      
      - name: E2E persistence (API→DB)
        working-directory: webcore_appcore_starter_4_17
        env:
          BFF_URL: http://localhost:8081
          TENANT_ID: default
          API_KEY_AUD: collector-key:auditor
          API_KEY_OP: collector-key:operator
          DATABASE_URL: postgres://app:app@localhost:5432/app
        run: npm run test:e2e:accounting:persistence
      
      - name: Stop BFF server
        run: pkill -f "bff-accounting" || true

  no-artifacts-committed:
    defaults:
      run:
        working-directory: webcore_appcore_starter_4_17
    name: Ensure no deps/build artifacts in git
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: webcore_appcore_starter_4_17
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Ensure no deps/build artifacts in git
        run: |
          if git ls-files | grep -E '(^|/)(node_modules|dist)(/|$)'; then
            echo "❌ Found tracked node_modules/dist files"
            echo "Files:"
            git ls-files | grep -E '(^|/)(node_modules|dist)(/|$)'
            exit 1
          else
            echo "✅ No build artifacts or dependencies tracked in git"
          fi

  gate-os-integration:
    name: OS Integration Gate
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: webcore_appcore_starter_4_17
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_DB: app
          POSTGRES_USER: app
          POSTGRES_PASSWORD: app
        ports:
          - "5432:5432"
        options: >-
          --health-cmd="pg_isready -U app -d app"
          --health-interval=5s
          --health-timeout=5s
          --health-retries=20
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: npm ci
      - name: Build packages
        run: npm run build:packages
      - name: DB migrate
        env:
          DATABASE_URL: postgres://app:app@localhost:5432/app
        run: npm run db:migrate
      - name: Start BFF
        env:
          DATABASE_URL: postgres://app:app@localhost:5432/app
          USE_PG: "1"
          EXPORT_SIGN_SECRET: ci-secret
          OS_POLICY_BRIDGE_ENFORCE: "true"
          OS_ROLE_MAP_JSON: '{"viewer":"viewer","operator":"operator","auditor":"auditor","admin":"admin"}'
        run: |
          cd packages/bff-accounting
          npm i
          npm run build
          node --enable-source-maps dist/index.js &
          sleep 3
          cd ../..
      - name: Test OS policy bridge (403 on invalid role)
        run: |
          response=$(curl -s -w "\n%{http_code}" -H 'X-Tenant: default' -H 'X-User-Id: u1' -H 'X-User-Role: unknown' http://localhost:8081/v1/accounting/audit)
          http_code=$(echo "$response" | tail -1)
          body=$(echo "$response" | head -1)
          if [ "$http_code" != "403" ]; then
            echo "❌ Expected 403, got $http_code"
            exit 1
          fi
          if ! echo "$body" | grep -q "OS_POLICY_DENY"; then
            echo "❌ Expected error_code=OS_POLICY_DENY"
            exit 1
          fi
          echo "✅ OS policy bridge correctly rejects invalid role"
      - name: Test audit API (auditor access)
        run: |
          response=$(curl -s -w "\n%{http_code}" -H 'X-Tenant: default' -H 'X-User-Id: u2' -H 'X-User-Role: auditor' 'http://localhost:8081/v1/accounting/audit?page=1&page_size=20')
          http_code=$(echo "$response" | tail -1)
          if [ "$http_code" != "200" ]; then
            echo "❌ Expected 200, got $http_code"
            exit 1
          fi
          echo "✅ Audit API accessible to auditor"
      - name: Test audit API (viewer denied)
        run: |
          response=$(curl -s -w "\n%{http_code}" -H 'X-Tenant: default' -H 'X-User-Id: u3' -H 'X-User-Role: viewer' 'http://localhost:8081/v1/accounting/audit')
          http_code=$(echo "$response" | tail -1)
          if [ "$http_code" != "403" ]; then
            echo "❌ Expected 403 for viewer, got $http_code"
            exit 1
          fi
          echo "✅ Viewer correctly denied access to audit API"
      - name: Test OS summary API
        run: |
          response=$(curl -s -w "\n%{http_code}" -H 'X-Tenant: default' -H 'X-User-Id: u4' -H 'X-User-Role: operator' http://localhost:8081/v1/accounting/os/summary)
          http_code=$(echo "$response" | tail -1)
          body=$(echo "$response" | head -1)
          if [ "$http_code" != "200" ]; then
            echo "❌ Expected 200, got $http_code"
            exit 1
          fi
          if ! echo "$body" | grep -q "approvals"; then
            echo "❌ Missing approvals field in summary"
            exit 1
          fi
          if ! echo "$body" | grep -q "exports"; then
            echo "❌ Missing exports field in summary"
            exit 1
          fi
          if ! echo "$body" | grep -q "recon"; then
            echo "❌ Missing recon field in summary"
            exit 1
          fi
          if ! echo "$body" | grep -q "errors"; then
            echo "❌ Missing errors field in summary"
            exit 1
          fi
          echo "✅ OS summary API returns expected fields"
      - name: Stop BFF
        run: pkill -f "bff-accounting" || true
