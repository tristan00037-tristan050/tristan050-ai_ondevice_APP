openapi: 3.0.3
info:
  title: Control Plane IAM API
  version: 1.0.0
  description: |
    Multi-tenant IAM foundation: Tenant/Project/Environment + RBAC + OIDC auth + immutable AuditLog.
    
    Fail-Closed: default deny. No token or insufficient permission => 401/403.
    Multi-tenancy: every record scoped by tenant_id; cross-tenant access blocked by design.
    Audit: every mutating API writes append-only audit record (no updates/deletes).
    Deterministic permissions: same token + same state => same decision.

servers:
  - url: https://api.example.com/api/v1
    description: Production server
  - url: http://localhost:3000/api/v1
    description: Local development server

security:
  - BearerAuth: []

paths:
  /iam/tenants:
    get:
      summary: List tenants
      description: List all tenants (admin only, tenant-scoped)
      operationId: listTenants
      tags:
        - Tenants
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  tenants:
                    type: array
                    items:
                      $ref: '#/components/schemas/Tenant'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
    post:
      summary: Create tenant
      description: Create a new tenant
      operationId: createTenant
      tags:
        - Tenants
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateTenantRequest'
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema:
                type: object
                properties:
                  tenant:
                    $ref: '#/components/schemas/Tenant'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /iam/tenants/{id}:
    get:
      summary: Get tenant by ID
      description: Get tenant details (tenant-scoped, cross-tenant access blocked)
      operationId: getTenant
      tags:
        - Tenants
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  tenant:
                    $ref: '#/components/schemas/Tenant'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
    patch:
      summary: Update tenant
      description: Update tenant (tenant-scoped, cross-tenant access blocked)
      operationId: updateTenant
      tags:
        - Tenants
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateTenantRequest'
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  tenant:
                    $ref: '#/components/schemas/Tenant'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  /iam/users:
    get:
      summary: List users
      description: List users (tenant-scoped)
      operationId: listUsers
      tags:
        - Users
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  users:
                    type: array
                    items:
                      $ref: '#/components/schemas/User'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
    post:
      summary: Create user
      description: Create a new user (tenant-scoped)
      operationId: createUser
      tags:
        - Users
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateUserRequest'
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema:
                type: object
                properties:
                  user:
                    $ref: '#/components/schemas/User'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /iam/users/{id}:
    get:
      summary: Get user by ID
      description: Get user details (tenant-scoped, cross-tenant access blocked)
      operationId: getUser
      tags:
        - Users
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  user:
                    $ref: '#/components/schemas/User'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
    patch:
      summary: Update user
      description: Update user (tenant-scoped, cross-tenant access blocked)
      operationId: updateUser
      tags:
        - Users
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateUserRequest'
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  user:
                    $ref: '#/components/schemas/User'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  /iam/roles:
    get:
      summary: List roles
      description: List roles (tenant-scoped)
      operationId: listRoles
      tags:
        - Roles
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  roles:
                    type: array
                    items:
                      $ref: '#/components/schemas/Role'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
    post:
      summary: Create role
      description: Create a new role (tenant-scoped)
      operationId: createRole
      tags:
        - Roles
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateRoleRequest'
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema:
                type: object
                properties:
                  role:
                    $ref: '#/components/schemas/Role'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /iam/roles/{id}:
    get:
      summary: Get role by ID
      description: Get role details (tenant-scoped, cross-tenant access blocked)
      operationId: getRole
      tags:
        - Roles
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  role:
                    $ref: '#/components/schemas/Role'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
    patch:
      summary: Update role
      description: Update role (tenant-scoped, cross-tenant access blocked)
      operationId: updateRole
      tags:
        - Roles
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateRoleRequest'
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  role:
                    $ref: '#/components/schemas/Role'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  /audit/logs:
    get:
      summary: Query audit logs
      description: Query audit logs (tenant-scoped, read-only, cross-tenant access blocked)
      operationId: queryAuditLogs
      tags:
        - Audit
      parameters:
        - name: user_id
          in: query
          schema:
            type: string
        - name: action
          in: query
          schema:
            type: string
            enum: [create, update, delete, read, login, logout, permission_denied]
        - name: resource_type
          in: query
          schema:
            type: string
            enum: [tenant, project, environment, user, role, audit_log]
        - name: resource_id
          in: query
          schema:
            type: string
        - name: start_date
          in: query
          schema:
            type: string
            format: date-time
        - name: end_date
          in: query
          schema:
            type: string
            format: date-time
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  logs:
                    type: array
                    items:
                      $ref: '#/components/schemas/AuditLog'
                  count:
                    type: integer
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: OIDC JWT token (verified via issuer/JWKS)

  schemas:
    Tenant:
      type: object
      required:
        - id
        - name
        - status
        - created_at
        - updated_at
      properties:
        id:
          type: string
        name:
          type: string
        status:
          type: string
          enum: [active, suspended, deleted]
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        metadata:
          type: object

    CreateTenantRequest:
      type: object
      required:
        - name
      properties:
        name:
          type: string
        metadata:
          type: object

    UpdateTenantRequest:
      type: object
      properties:
        name:
          type: string
        status:
          type: string
          enum: [active, suspended]
        metadata:
          type: object

    User:
      type: object
      required:
        - id
        - tenant_id
        - email
        - name
        - status
        - created_at
        - updated_at
      properties:
        id:
          type: string
        tenant_id:
          type: string
        email:
          type: string
        name:
          type: string
        status:
          type: string
          enum: [active, suspended, deleted]
        oidc_sub:
          type: string
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        metadata:
          type: object

    CreateUserRequest:
      type: object
      required:
        - tenant_id
        - email
        - name
      properties:
        tenant_id:
          type: string
        email:
          type: string
        name:
          type: string
        oidc_sub:
          type: string
        metadata:
          type: object

    UpdateUserRequest:
      type: object
      properties:
        email:
          type: string
        name:
          type: string
        status:
          type: string
          enum: [active, suspended]
        metadata:
          type: object

    Role:
      type: object
      required:
        - id
        - tenant_id
        - name
        - permissions
        - created_at
        - updated_at
      properties:
        id:
          type: string
        tenant_id:
          type: string
        name:
          type: string
        description:
          type: string
        permissions:
          type: array
          items:
            type: string
            enum: [tenant:read, tenant:write, project:read, project:write, environment:read, environment:write, user:read, user:write, role:read, role:write, audit:read]
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    CreateRoleRequest:
      type: object
      required:
        - tenant_id
        - name
        - permissions
      properties:
        tenant_id:
          type: string
        name:
          type: string
        description:
          type: string
        permissions:
          type: array
          items:
            type: string

    UpdateRoleRequest:
      type: object
      properties:
        name:
          type: string
        description:
          type: string
        permissions:
          type: array
          items:
            type: string

    AuditLog:
      type: object
      required:
        - id
        - tenant_id
        - user_id
        - action
        - resource_type
        - resource_id
        - success
        - created_at
      properties:
        id:
          type: string
        tenant_id:
          type: string
        user_id:
          type: string
        action:
          type: string
          enum: [create, update, delete, read, login, logout, permission_denied]
        resource_type:
          type: string
          enum: [tenant, project, environment, user, role, audit_log]
        resource_id:
          type: string
        ip_address:
          type: string
        user_agent:
          type: string
        request_id:
          type: string
        success:
          type: boolean
        error_message:
          type: string
        metadata:
          type: object
        created_at:
          type: string
          format: date-time

  responses:
    Unauthorized:
      description: Unauthorized (no token or invalid token)
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: string
                example: Unauthorized
              message:
                type: string

    Forbidden:
      description: Forbidden (insufficient permission or cross-tenant access)
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: string
                example: Forbidden
              message:
                type: string

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: string
                example: Not found

