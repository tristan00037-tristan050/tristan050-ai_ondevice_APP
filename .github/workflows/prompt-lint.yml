name: prompt-lint

on:
  pull_request:
    paths:
      - '.cursor/rules/**'
      - 'docs/ops/cursor_prompts/**'
      - 'docs/ops/contracts/**'
      - 'webcore_appcore_starter_4_17/backend/control_plane/**'
      - 'webcore_appcore_starter_4_17/scripts/verify/**'
  merge_group:
  workflow_dispatch:

jobs:
  verify_control_plane:
    name: Verify Control Plane DoD
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies (fail-closed)
        working-directory: webcore_appcore_starter_4_17/backend/control_plane
        run: |
          set -euo pipefail
          if [ -f package.json ]; then
            if [ -f package-lock.json ]; then
              npm ci
            else
              npm install
            fi
          fi
      
      - name: Run Control Plane verification (capture log)
        id: verify_control_plane
        working-directory: webcore_appcore_starter_4_17
        run: |
          set -euo pipefail
          LOG="/tmp/verify_control_plane_${GITHUB_RUN_ID}.log"
          echo "LOG=$LOG"
          bash scripts/verify/verify_control_plane.sh 2>&1 | tee "$LOG"
      
      - name: Show log on failure
        if: always()
        run: |
          set -euo pipefail
          LOG="/tmp/verify_control_plane_${GITHUB_RUN_ID}.log"
          if [ "${{ steps.verify_control_plane.outcome }}" != "success" ]; then
            echo "FAIL: Control Plane verification failed"
            echo "---- last 200 lines ----"
            tail -n 200 "$LOG" || true
            exit 1
          fi

  guard_no_unconditional_ok:
    name: Guard: No Unconditional OK in Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Check for unconditional OK=1 patterns
        working-directory: webcore_appcore_starter_4_17
        run: |
          bash scripts/verify/verify_no_unconditional_ok.sh

  prompt_lint_check:
    name: prompt-lint-check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        env:
          PROMPT_LINT_PR_BASE_SHA: ${{ github.event.pull_request.base.sha }}
          PROMPT_LINT_MERGE_GROUP_BASE_SHA: ${{ github.event.merge_group.base_sha }}
          PROMPT_LINT_PUSH_BEFORE: ${{ github.event.before }}
          PROMPT_LINT_HEAD_SHA: ${{ github.sha }}
        run: |
          set -euo pipefail

          # Resolve BASE_SHA from event type (fail-closed)
          if [ -n "${PROMPT_LINT_PR_BASE_SHA:-}" ]; then
            export PROMPT_LINT_BASE_SHA="${PROMPT_LINT_PR_BASE_SHA}"
          elif [ -n "${PROMPT_LINT_MERGE_GROUP_BASE_SHA:-}" ]; then
            export PROMPT_LINT_BASE_SHA="${PROMPT_LINT_MERGE_GROUP_BASE_SHA}"
          elif [ -n "${PROMPT_LINT_PUSH_BEFORE:-}" ]; then
            export PROMPT_LINT_BASE_SHA="${PROMPT_LINT_PUSH_BEFORE}"
          else
            echo "FAIL: Could not determine BASE_SHA from event (fail-closed)"
            exit 1
          fi

          export PROMPT_LINT_HEAD_SHA="${PROMPT_LINT_HEAD_SHA}"

          LOG="/tmp/verify_prompt_quality_${GITHUB_RUN_ID}.log"
          echo "LOG=$LOG"
          bash scripts/ops/verify_prompt_quality.sh 2>&1 | tee "$LOG"

      - name: Show log on failure
        if: always()
        run: |
          set -euo pipefail
          LOG="/tmp/verify_prompt_quality_${GITHUB_RUN_ID}.log"
          if [ -f "$LOG" ]; then
            echo "---- last 200 lines ----"
            tail -n 200 "$LOG" || true
          fi

  prompt_lint_gate:
    name: prompt-lint
    runs-on: ubuntu-latest
    needs: [verify_control_plane, guard_no_unconditional_ok, prompt_lint_check]
    if: always()
    steps:
      - name: Gate (fail-closed)
        run: |
          set -euo pipefail
          if [ "${{ needs.verify_control_plane.result }}" = "skipped" ]; then
            echo "FAIL: verify_control_plane was skipped (fail-closed)"
            exit 1
          fi
          if [ "${{ needs.verify_control_plane.result }}" != "success" ]; then
            echo "FAIL: verify_control_plane result was ${{ needs.verify_control_plane.result }} (fail-closed)"
            exit 1
          fi
          if [ "${{ needs.guard_no_unconditional_ok.result }}" = "skipped" ]; then
            echo "FAIL: guard_no_unconditional_ok was skipped (fail-closed)"
            exit 1
          fi
          if [ "${{ needs.guard_no_unconditional_ok.result }}" != "success" ]; then
            echo "FAIL: guard_no_unconditional_ok result was ${{ needs.guard_no_unconditional_ok.result }} (fail-closed)"
            exit 1
          fi
          if [ "${{ needs.prompt_lint_check.result }}" = "skipped" ]; then
            echo "FAIL: prompt_lint_check was skipped (fail-closed)"
            exit 1
          fi
          if [ "${{ needs.prompt_lint_check.result }}" != "success" ]; then
            echo "FAIL: prompt_lint_check result was ${{ needs.prompt_lint_check.result }} (fail-closed)"
            exit 1
          fi
          echo "PASS: All upstream jobs completed successfully"
