name: prompt-lint

on:
  pull_request: {}
  merge_group: {}
  workflow_dispatch: {}

jobs:
  prompt_lint_check:
    name: prompt-lint-check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Prompt lint (capture log)
        env:
          PROMPT_LINT_PR_BASE_SHA: ${{ github.event.pull_request.base.sha }}
          PROMPT_LINT_MERGE_GROUP_BASE_SHA: ${{ github.event.merge_group.base_sha }}
          PROMPT_LINT_PUSH_BEFORE: ${{ github.event.before }}
          PROMPT_LINT_HEAD_SHA: ${{ github.sha }}
        run: |
          set -euo pipefail

          # Resolve BASE_SHA from event type (fail-closed)
          if [ -n "${PROMPT_LINT_PR_BASE_SHA:-}" ]; then
            export PROMPT_LINT_BASE_SHA="${PROMPT_LINT_PR_BASE_SHA}"
          elif [ -n "${PROMPT_LINT_MERGE_GROUP_BASE_SHA:-}" ]; then
            export PROMPT_LINT_BASE_SHA="${PROMPT_LINT_MERGE_GROUP_BASE_SHA}"
          elif [ -n "${PROMPT_LINT_PUSH_BEFORE:-}" ]; then
            export PROMPT_LINT_BASE_SHA="${PROMPT_LINT_PUSH_BEFORE}"
          else
            echo "FAIL: Could not determine BASE_SHA from event (fail-closed)"
            exit 1
          fi

          export PROMPT_LINT_HEAD_SHA="${PROMPT_LINT_HEAD_SHA}"

          LOG="/tmp/verify_prompt_quality_${GITHUB_RUN_ID}.log"
          echo "LOG=$LOG"
          bash scripts/ops/verify_prompt_quality.sh 2>&1 | tee "$LOG"

      - name: Show log on failure
        if: always()
        run: |
          set -euo pipefail
          LOG="/tmp/verify_prompt_quality_${GITHUB_RUN_ID}.log"
          if [ -f "$LOG" ]; then
            echo "---- last 200 lines ----"
            tail -n 200 "$LOG" || true
          fi

  prompt_lint_gate:
    name: prompt-lint
    runs-on: ubuntu-latest
    needs: [prompt_lint_check]
    if: always()
    steps:
      - name: Gate (fail-closed)
        run: |
          set -euo pipefail
          if [ "${{ needs.prompt_lint_check.result }}" = "skipped" ]; then
            echo "FAIL: prompt_lint_check was skipped (fail-closed)"
            exit 1
          fi
          if [ "${{ needs.prompt_lint_check.result }}" != "success" ]; then
            echo "FAIL: prompt_lint_check result was ${{ needs.prompt_lint_check.result }} (fail-closed)"
            exit 1
          fi
          echo "PASS: prompt_lint_check completed successfully"
