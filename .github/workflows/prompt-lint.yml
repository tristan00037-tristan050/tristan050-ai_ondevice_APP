name: prompt-lint

on:
  pull_request: {}
  merge_group: {}
  workflow_dispatch: {}

jobs:
  prompt_lint_check:
    name: prompt-lint-check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Resolve BASE/HEAD sha (fail-closed)
        run: |
          set -euo pipefail
          python3 - <<'PY'
          import json, os, subprocess, sys

          event_name = os.environ.get("GITHUB_EVENT_NAME", "")
          event_path = os.environ.get("GITHUB_EVENT_PATH", "")
          if not event_path:
            print("FAIL: GITHUB_EVENT_PATH missing")
            sys.exit(1)

          with open(event_path, "r", encoding="utf-8") as f:
            data = json.load(f)

          def die(msg):
            print(f"FAIL: {msg}")
            sys.exit(1)

          base = head = None

          if event_name == "pull_request":
            pr = data.get("pull_request", {})
            base = pr.get("base", {}).get("sha")
            head = pr.get("head", {}).get("sha")

          elif event_name == "merge_group":
            mg = data.get("merge_group", {})
            base = mg.get("base_sha")
            head = os.environ.get("GITHUB_SHA")

          elif event_name == "workflow_dispatch":
            base = subprocess.check_output(["git", "rev-parse", "HEAD~1"], text=True).strip()
            head = subprocess.check_output(["git", "rev-parse", "HEAD"], text=True).strip()

          else:
            die(f"unsupported event_name={event_name}")

          if not base or not head:
            die(f"could not resolve base/head sha (event_name={event_name})")

          with open(os.environ["GITHUB_ENV"], "a", encoding="utf-8") as env:
            env.write(f"PROMPT_LINT_BASE_SHA={base}\n")
            env.write(f"PROMPT_LINT_HEAD_SHA={head}\n")

          print(f"PROMPT_LINT_BASE_SHA={base}")
          print(f"PROMPT_LINT_HEAD_SHA={head}")
          PY

      - name: Prompt lint (capture log)
        run: |
          set -euo pipefail
          LOG="/tmp/verify_prompt_quality_${GITHUB_RUN_ID}.log"
          echo "LOG=$LOG"
          bash scripts/ops/verify_prompt_quality.sh 2>&1 | tee "$LOG"

      - name: Show log tail (always)
        if: always()
        run: |
          set -euo pipefail
          LOG="/tmp/verify_prompt_quality_${GITHUB_RUN_ID}.log"
          if [ -f "$LOG" ]; then
            echo "---- last 200 lines ----"
            tail -n 200 "$LOG" || true
          fi

  prompt_lint_gate:
    name: prompt-lint
    runs-on: ubuntu-latest
    needs: [prompt_lint_check]
    if: always()
    steps:
      - name: Gate (fail-closed)
        run: |
          set -euo pipefail
          if [ "${{ needs.prompt_lint_check.result }}" = "skipped" ]; then
            echo "FAIL: prompt_lint_check was skipped (fail-closed)"
            exit 1
          fi
          if [ "${{ needs.prompt_lint_check.result }}" != "success" ]; then
            echo "FAIL: prompt_lint_check result was ${{ needs.prompt_lint_check.result }} (fail-closed)"
            exit 1
          fi
          echo "PASS: prompt_lint_check completed successfully"
