name: prompt-lint

on:
  pull_request:
    paths:
      - '.cursor/rules/**'
      - 'docs/ops/cursor_prompts/**'
      - 'docs/ops/contracts/**'
      - 'webcore_appcore_starter_4_17/backend/control_plane/**'
      - 'webcore_appcore_starter_4_17/scripts/verify/**'
  merge_group:
  workflow_dispatch:

jobs:
  verify_control_plane:
    name: Verify Control Plane DoD
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        working-directory: webcore_appcore_starter_4_17/backend/control_plane
        run: |
          if [ -f package.json ]; then
            npm install || true
          fi
      
      - name: Run Control Plane verification
        working-directory: webcore_appcore_starter_4_17
        run: |
          bash scripts/verify/verify_control_plane.sh
        id: verify_control_plane
      
      - name: Check verification output
        if: always()
        run: |
          if [ "${{ steps.verify_control_plane.outcome }}" != "success" ]; then
            echo "FAIL: Control Plane verification failed"
            exit 1
          fi

  guard_no_unconditional_ok:
    name: Guard: No Unconditional OK in Tests
    name: "Guard: No Unconditional OK in Tests"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Check for unconditional OK=1 patterns
        working-directory: webcore_appcore_starter_4_17
        run: |
          bash scripts/verify/verify_no_unconditional_ok.sh

  prompt_lint_gate:
    name: prompt-lint
    needs: [verify_control_plane, guard_no_unconditional_ok]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - uses: actions/checkout@v4
      
      - name: Set environment variables
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "PROMPT_LINT_BASE_SHA=${{ github.event.pull_request.base.sha }}" >> $GITHUB_ENV
            echo "PROMPT_LINT_HEAD_SHA=${{ github.event.pull_request.head.sha }}" >> $GITHUB_ENV
          else
            echo "PROMPT_LINT_BASE_SHA=$(git rev-parse HEAD~1)" >> $GITHUB_ENV
            echo "PROMPT_LINT_HEAD_SHA=$(git rev-parse HEAD)" >> $GITHUB_ENV
          fi
      
      - name: Prompt lint gate (fail-closed, meta-only)
        working-directory: webcore_appcore_starter_4_17
        run: |
          bash scripts/ops/verify_prompt_quality.sh
      
      - name: Check upstream jobs
        if: always()
        run: |
          if [ "${{ needs.verify_control_plane.result }}" != "success" ]; then
            echo "FAIL: verify_control_plane job failed"
            exit 1
          fi
          if [ "${{ needs.guard_no_unconditional_ok.result }}" != "success" ]; then
            echo "FAIL: guard_no_unconditional_ok job failed"
            exit 1
          fi
          echo "PASS: All upstream jobs succeeded"
