# PREP_TOKEN=1
name: product-verify-perf-real-pipeline-schedule

on:
  pull_request:
  merge_group:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * 1"  # 매주 월요일 03:00 UTC

permissions:
  contents: read

jobs:
  verify:
    runs-on: ubuntu-latest
    env:
      PLAYWRIGHT_BROWSERS_PATH: ~/.cache/ms-playwright
      WEB_E2E_DIR: webcore_appcore_starter_4_17/scripts/web_e2e

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: webcore_appcore_starter_4_17/scripts/web_e2e/package-lock.json

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ format('{0}-ms-playwright-{1}', runner.os, hashFiles('webcore_appcore_starter_4_17/scripts/web_e2e/package-lock.json')) }}
          restore-keys: |
            ${{ runner.os }}-ms-playwright-

      - name: Install deps (web_e2e)
        run: npm --prefix "${WEB_E2E_DIR}" ci

      - name: Install Playwright browsers (chromium)
        env:
          PLAYWRIGHT_BROWSERS_PATH: ${{ env.PLAYWRIGHT_BROWSERS_PATH }}
        run: npx --prefix "${WEB_E2E_DIR}" playwright install --with-deps chromium

      # schedule일 때만 PERF_RUN_MODE=schedule로 설정 (YAML if 없이 run 내부에서 결정)
      - name: Set PERF_RUN_MODE
        run: |
          set -euo pipefail
          MODE="merge"
          if [ "${GITHUB_EVENT_NAME}" = "schedule" ]; then MODE="schedule"; fi
          echo "PERF_RUN_MODE=${MODE}" >> "$GITHUB_ENV"
          echo "MODE=${MODE}"

      - name: Verify perf real pipeline (N/variance)
        env:
          PLAYWRIGHT_BROWSERS_PATH: ${{ env.PLAYWRIGHT_BROWSERS_PATH }}
        run: |
          set -euo pipefail
          bash scripts/verify/verify_perf_real_pipeline_p95.sh

  gate:
    runs-on: ubuntu-latest
    needs: [verify]
    steps:
      - name: gate
        run: |
          if [ "${{ needs.verify.result }}" != "success" ]; then
            echo "GATE:FAIL"
            exit 1
          fi
          echo "GATE:OK"
