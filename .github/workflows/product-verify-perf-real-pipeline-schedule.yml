name: product-verify-perf-real-pipeline-schedule

on:
  schedule:
    - cron: "0 3 * * 1"  # 매주 월요일 03:00 UTC (원하는 시간으로 조정 가능)
  workflow_dispatch:

permissions:
  contents: read

jobs:
  verify:
    runs-on: ubuntu-latest
    env:
      PLAYWRIGHT_BROWSERS_PATH: ~/.cache/ms-playwright
      WEB_E2E_DIR: webcore_appcore_starter_4_17/scripts/web_e2e
      PERF_RUN_MODE: schedule

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: webcore_appcore_starter_4_17/scripts/web_e2e/package-lock.json

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ format('{0}-ms-playwright-{1}', runner.os, hashFiles('webcore_appcore_starter_4_17/scripts/web_e2e/package-lock.json')) }}
          restore-keys: |
            ${{ runner.os }}-ms-playwright-

      - name: Install deps (web_e2e)
        run: npm --prefix "${WEB_E2E_DIR}" ci

      - name: Install Playwright browsers (chromium)
        env:
          PLAYWRIGHT_BROWSERS_PATH: ${{ env.PLAYWRIGHT_BROWSERS_PATH }}
        run: npx --prefix "${WEB_E2E_DIR}" playwright install --with-deps chromium

      - name: Verify perf real pipeline (N/variance)
        env:
          PLAYWRIGHT_BROWSERS_PATH: ${{ env.PLAYWRIGHT_BROWSERS_PATH }}
          PERF_RUN_MODE: schedule
        run: |
          set -euo pipefail
          bash scripts/verify/verify_perf_real_pipeline_p95.sh

  gate:
    runs-on: ubuntu-latest
    needs: [verify]
    steps:
      - name: gate
        run: |
          if [ "${{ needs.verify.result }}" != "success" ]; then
            echo "GATE:FAIL"
            exit 1
          fi
          echo "GATE:OK"

