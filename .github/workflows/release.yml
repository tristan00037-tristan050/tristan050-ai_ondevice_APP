    repo-contracts-gate:
    name: Repo contracts + autodecision gate
    runs-on: ubuntu-latest
    env:
      ONPREM_PROOF_STRICT_ENFORCE: "1"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Debug: show checked-out SHA
        shell: bash
        run: |
          set -euo pipefail
          echo "GITHUB_REF=${GITHUB_REF}"
          echo "GITHUB_SHA=${GITHUB_SHA}"
          git rev-parse HEAD
          git show -s --format=%H%n%an%n%ad%n%s HEAD

      - name: Install ripgrep
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y ripgrep jq

      - name: Debug: scan forbidden attestation patterns in workflows
        shell: bash
        run: |
          set -euo pipefail
          rg -n "id-token\s*:\s*write|attestations\s*:\s*write|artifact-metadata\s*:\s*write|attest-build-provenance" .github/workflows || true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Preflight (single source)
        uses: ./.github/actions/preflight_v1

      - name: Ops deps preflight (fail-closed)
        shell: bash
        run: |
          set -euo pipefail
          bash scripts/verify/verify_ops_deps.sh --require-node-npm --require-rg --require-jq

      - name: Install deps (web_e2e)
        run: |
          npm --prefix webcore_appcore_starter_4_17/scripts/web_e2e ci

      - name: Install Playwright browsers
        run: |
          npx --prefix webcore_appcore_starter_4_17/scripts/web_e2e playwright install --with-deps chromium
        env:
          PLAYWRIGHT_BROWSERS_PATH: ${{ runner.temp }}/ms-playwright

      - name: Debug: show dist build stamp sha
        shell: bash
        run: |
          set -euo pipefail
          STAMP="webcore_appcore_starter_4_17/packages/bff-accounting/dist/.build_stamp.json"
          test -f "$STAMP" || { echo "missing stamp: $STAMP"; exit 1; }
          echo "HEAD=$(git rev-parse HEAD)"
          node -e 'const fs=require("fs"); const j=JSON.parse(fs.readFileSync(process.argv[1],"utf8")); console.log("STAMP.git_sha="+j.git_sha); console.log("STAMP.workflow_name="+j.workflow_name); console.log("STAMP.built_at_utc="+j.built_at_utc);' "$STAMP"

      - name: Generate latest reports (A)
        shell: bash
        run: |
          set -euo pipefail
          bash scripts/ops/gen_repo_guard_report_v1.sh
          bash scripts/ops/run_ai_smoke_v1.sh
        env:
          PLAYWRIGHT_BROWSERS_PATH: ${{ runner.temp }}/ms-playwright

      - name: Generate autodecision (B)
        shell: bash
        run: |
          set -euo pipefail
          node scripts/ops/gen_autodecision_v1.mjs

      - name: Repo contracts gate
        shell: bash
        run: |
          set -euo pipefail
          bash scripts/verify/verify_repo_contracts.sh 2>&1 | tee /tmp/verify_repo_contracts.log
          rc=${PIPESTATUS[0]}
          if [ "$rc" -ne 0 ]; then
            echo "=== tail verify_repo_contracts (last 200 lines) ==="
            tail -n 200 /tmp/verify_repo_contracts.log || true
          fi
          exit "$rc"
        env:
          PLAYWRIGHT_BROWSERS_PATH: ${{ runner.temp }}/ms-playwright

      - name: Release gate (autodecision must be ok) (C)
        shell: bash
        run: |
          set -euo pipefail
          test -s docs/ops/reports/autodecision_latest.json
          node -e 'const p=require("./docs/ops/reports/autodecision_latest.json"); if(p.decision!=="ok"){console.error("BLOCK: autodecision decision="+p.decision); console.error("reason_codes="+JSON.stringify(p.reason_codes)); process.exit(1)}'
