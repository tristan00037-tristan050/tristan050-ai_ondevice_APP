# P0-02: When autodecision SSOT files change, prove producer emit + required keys presence.
name: ci-ssot-change-contract

on:
  pull_request:
  merge_group:

permissions:
  contents: read

jobs:
  ssot-change-contract:
    name: ssot-change-contract
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install ripgrep
        run: |
          sudo apt-get update
          sudo apt-get install -y ripgrep

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Verify autodecision keys SSOT hygiene v1
        run: |
          set -euo pipefail
          bash scripts/verify/verify_autodecision_keys_ssot_hygiene_v1.sh

      - name: Verify autodecision SSOT change contract v1
        env:
          REPO_GUARD_KEYS_ONLY: "1"
        run: |
          set -euo pipefail
          REPO_GUARD_KEYS_ONLY=1 bash scripts/verify/verify_autodecision_ssot_change_contract_v1.sh

      - name: Run exec mode v1 (mock)
        run: |
          set -euo pipefail
          EXEC_MODE_OUTPUT_ROOT=out/exec_mode_docs bash tools/exec_mode/run_exec_mode_v1.sh \
            --engine mock \
            --inputs tools/exec_mode/fixtures/prompts_smoke.jsonl \
            --outdir out/exec_mode

      - name: Run exec mode v1 (ondevice_candidate_v0)
        run: |
          set -euo pipefail
          EXEC_MODE_OUTPUT_ROOT=out/exec_mode_docs bash tools/exec_mode/run_exec_mode_v1.sh \
            --engine ondevice_candidate_v0 \
            --inputs tools/exec_mode/fixtures/prompts_smoke.jsonl \
            --outdir out/exec_mode

      - name: Run exec mode v1 (ondevice_candidate_v0) twice to verify archive non-overwrite
        run: |
          set -euo pipefail
          EXEC_MODE_OUTPUT_ROOT=out/exec_mode_docs
          UTC_DATE="$(date -u +%F)"
          CNT_BEFORE="$(find "${EXEC_MODE_OUTPUT_ROOT}/EXEC_MODE_RUNS/${UTC_DATE}" -maxdepth 1 -type f -name "ondevice_candidate_v0__*.md" 2>/dev/null | wc -l | tr -d ' ')"

          # first run
          EXEC_MODE_OUTPUT_ROOT=out/exec_mode_docs bash tools/exec_mode/run_exec_mode_v1.sh --engine ondevice_candidate_v0 --inputs tools/exec_mode/fixtures/prompts_smoke.jsonl --outdir out/exec_mode
          bash tools/exec_mode/verify_exec_mode_v1.sh --inputs tools/exec_mode/fixtures/prompts_smoke.jsonl --outdir out/exec_mode

          # second run (same UTC date, same engine)
          EXEC_MODE_OUTPUT_ROOT=out/exec_mode_docs bash tools/exec_mode/run_exec_mode_v1.sh --engine ondevice_candidate_v0 --inputs tools/exec_mode/fixtures/prompts_smoke.jsonl --outdir out/exec_mode
          bash tools/exec_mode/verify_exec_mode_v1.sh --inputs tools/exec_mode/fixtures/prompts_smoke.jsonl --outdir out/exec_mode

          CNT_AFTER="$(find "${EXEC_MODE_OUTPUT_ROOT}/EXEC_MODE_RUNS/${UTC_DATE}" -maxdepth 1 -type f -name "ondevice_candidate_v0__*.md" | wc -l | tr -d ' ')"
          EXPECTED="$((CNT_BEFORE + 2))"
          if [ "${CNT_AFTER}" -lt "${EXPECTED}" ]; then
            echo "BLOCK: archive overwrite detected (count delta < 2): before=${CNT_BEFORE} after=${CNT_AFTER} expected>=${EXPECTED}" >&2
            exit 1
          fi

          EXEC_MODE_OUTPUT_ROOT=out/exec_mode_docs bash tools/exec_mode/verify_exec_mode_archive_v1.sh --engine ondevice_candidate_v0 --utc-date "${UTC_DATE}"

      - name: "Guard: CI must not leave docs/ artifacts (tracked + untracked)"
        run: |
          set -euo pipefail
          # exec-mode steps may generate docs artifacts for runtime checks; CI must finish clean.
          # 1) Revert tracked report updates (generated during run)
          git restore --source=HEAD --worktree --staged -- docs/EXEC_MODE_REPORT_V1.md || true

          # 2) Remove untracked run archives generated during CI
          git clean -fd -- docs/EXEC_MODE_RUNS || true

          # 3) Final guard: no tracked diffs under docs/
          if ! git diff --quiet -- docs/; then
            echo "BLOCK: CI left tracked docs/ diffs after cleanup" >&2
            git diff -- docs/ | head -n 200 >&2 || true
            exit 1
          fi

          # 4) Final guard: no untracked files under docs/
          UNTRACKED="$(git ls-files --others --exclude-standard -- docs/ || true)"
          if [ -n "${UNTRACKED}" ]; then
            echo "BLOCK: CI left untracked docs/ artifacts after cleanup" >&2
            printf '%s\n' "${UNTRACKED}" | head -n 200 >&2 || true
            exit 1
          fi

      - name: Verify exec mode v1 (fail-closed)
        run: |
          set -euo pipefail
          bash tools/exec_mode/verify_exec_mode_v1.sh \
            --inputs tools/exec_mode/fixtures/prompts_smoke.jsonl \
            --outdir out/exec_mode
