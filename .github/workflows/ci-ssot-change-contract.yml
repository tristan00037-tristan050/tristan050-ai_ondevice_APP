# P0-02: When autodecision SSOT files change, prove producer emit + required keys presence.
name: ci-ssot-change-contract

on:
  pull_request:
  merge_group:

permissions:
  contents: read

jobs:
  ssot-change-contract:
    name: ssot-change-contract
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install ripgrep
        run: |
          sudo apt-get update
          sudo apt-get install -y ripgrep

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Verify autodecision keys SSOT hygiene v1
        run: |
          set -euo pipefail
          bash scripts/verify/verify_autodecision_keys_ssot_hygiene_v1.sh

      - name: Verify autodecision SSOT change contract v1
        env:
          REPO_GUARD_KEYS_ONLY: "1"
        run: |
          set -euo pipefail
          REPO_GUARD_KEYS_ONLY=1 bash scripts/verify/verify_autodecision_ssot_change_contract_v1.sh

      - name: Run exec mode v1 (mock)
        run: |
          set -euo pipefail
          bash tools/exec_mode/run_exec_mode_v1.sh \
            --engine mock \
            --inputs tools/exec_mode/fixtures/prompts_smoke.jsonl \
            --outdir out/exec_mode

      - name: Verify exec mode v1 (fail-closed)
        run: |
          set -euo pipefail
          bash tools/exec_mode/verify_exec_mode_v1.sh \
            --inputs tools/exec_mode/fixtures/prompts_smoke.jsonl \
            --outdir out/exec_mode
