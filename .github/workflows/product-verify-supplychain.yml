# PREP_TOKEN=1
name: product-verify-supplychain

on:
  pull_request: {}
  merge_group: {}
  push:
    branches: ["main"]
  workflow_dispatch: {}

permissions:
  contents: read
  id-token: write
  attestations: write
  artifact-metadata: write

jobs:
  verify_slsa_provenance_min:
    name: verify-slsa-provenance-min
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ github.token }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Create minimal provenance (file)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p .artifacts
          node <<'NODE'
          const fs = require('fs');
          const repo = process.env.GITHUB_REPOSITORY || '';
          const sha = process.env.GITHUB_SHA || '';
          const runId = process.env.GITHUB_RUN_ID || '';
          const runUrl = `${process.env.GITHUB_SERVER_URL}/${repo}/actions/runs/${runId}`;
          const now = new Date();
          const started = new Date(now.getTime() - 1000).toISOString();
          const finished = now.toISOString();
          const out = {
            _type: "https://in-toto.io/Statement/v1",
            subject: [
              {
                name: "repo",
                digest: {
                  sha256: sha ? sha.padStart(64, '0').slice(0, 64) : "0".repeat(64)
                }
              }
            ],
            predicateType: "https://slsa.dev/provenance/v1",
            predicate: {
              buildType: "https://github.com/actions/workflow",
              builder: { id: "github-actions" },
              invocation: {
                parameters: { repo, sha, run_id: runId, run_url: runUrl }
              },
              metadata: { buildStartedOn: started, buildFinishedOn: finished },
              materials: [
                {
                  uri: `git+https://github.com/${repo}@${sha}`,
                  digest: { sha256: sha ? sha.padStart(64, '0').slice(0, 64) : "0".repeat(64) }
                }
              ]
            }
          };
          fs.writeFileSync(".artifacts/slsa_provenance_min.json", JSON.stringify(out));
          NODE

      - name: Verify SLSA provenance min (fail-closed)
        shell: bash
        run: |
          set -euo pipefail
          bash scripts/verify/verify_slsa_provenance_min.sh

      - name: Upload provenance artifact
        uses: actions/upload-artifact@v4
        with:
          name: slsa_provenance_min
          path: .artifacts/slsa_provenance_min.json

  attest_dsse_provenance:
    name: attest-dsse-provenance
    runs-on: ubuntu-latest
    needs: [verify_slsa_provenance_min]
    env:
      GH_TOKEN: ${{ github.token }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Skip attestation on PR/merge_group (report OK, no network)
        if: ${{ github.event_name != 'push' || github.ref != 'refs/heads/main' }}
        shell: bash
        run: |
          set -euo pipefail
          echo "SKIP: attestation is main-only (to avoid PR/merge_group network flakiness)"

      - name: Prepare subject for attestation (main only)
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p .artifacts
          {
            echo "repo=${GITHUB_REPOSITORY}"
            echo "sha=${GITHUB_SHA}"
            echo "run_id=${GITHUB_RUN_ID}"
            echo "run_attempt=${GITHUB_RUN_ATTEMPT:-0}"
          } > .artifacts/supplychain_subject.txt

      - name: Generate DSSE provenance attestation (main only)
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        uses: actions/attest-build-provenance@v3
        with:
          subject-path: .artifacts/supplychain_subject.txt

      - name: Install deps for verify (jq) (main only)
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y jq

      - name: Verify DSSE attestation (fail-closed) (main only)
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        shell: bash
        run: |
          set -euo pipefail
          bash scripts/verify/verify_slsa_dsse_attestation.sh

  gate:
    name: gate
    runs-on: ubuntu-latest
    needs: [verify_slsa_provenance_min, attest_dsse_provenance]
    steps:
      - name: Gate (PR/merge_group: provenance_min only, main: require DSSE)
        shell: bash
        run: |
          set -euo pipefail
          echo "provenance_min=${{ needs.verify_slsa_provenance_min.result }}"
          echo "attest_dsse=${{ needs.attest_dsse_provenance.result }}"
          echo "event_name=${GITHUB_EVENT_NAME}"
          echo "ref=${GITHUB_REF}"

          if [ "${{ needs.verify_slsa_provenance_min.result }}" != "success" ]; then
            echo "GATE:FAIL (provenance_min)"
            exit 1
          fi

          if [ "${GITHUB_EVENT_NAME}" = "push" ] && [ "${GITHUB_REF}" = "refs/heads/main" ]; then
            if [ "${{ needs.attest_dsse_provenance.result }}" != "success" ]; then
              echo "GATE:FAIL (dsse required on main)"
              exit 1
            fi
          fi

          echo "GATE:OK"
