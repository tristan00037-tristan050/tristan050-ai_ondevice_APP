name: product-verify-supplychain

on:
  pull_request:
  merge_group:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: read
  id-token: write
  attestations: write
  artifact-metadata: write

jobs:
  provenance_min:
    name: verify-slsa-provenance-min
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ github.token }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Create minimal provenance (file)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p .artifacts
          node <<'NODE'
          const fs = require('fs');
          const repo = process.env.GITHUB_REPOSITORY || '';
          const sha = process.env.GITHUB_SHA || '';
          const runId = process.env.GITHUB_RUN_ID || '';
          const runUrl = `${process.env.GITHUB_SERVER_URL}/${repo}/actions/runs/${runId}`;
          const now = new Date();
          const started = new Date(now.getTime() - 1000).toISOString();
          const finished = now.toISOString();

          // Minimal, audit-friendly statement:
          // - 목적: 존재/형식/링크 핀ning (PR에서도 네트워크 의존 없이 통과 가능)
          const out = {
            _type: "https://in-toto.io/Statement/v1",
            subject: [
              {
                name: "repo",
                digest: {
                  sha256: sha ? sha.padStart(64, '0').slice(0, 64) : "0".repeat(64)
                }
              }
            ],
            predicateType: "https://slsa.dev/provenance/v1",
            predicate: {
              buildType: "https://github.com/actions/workflow",
              builder: { id: "github-actions" },
              invocation: {
                parameters: {
                  repo,
                  sha,
                  run_id: runId,
                  run_url: runUrl
                }
              },
              metadata: {
                buildStartedOn: started,
                buildFinishedOn: finished
              },
              materials: [
                {
                  uri: `git+https://github.com/${repo}@${sha}`,
                  digest: {
                    sha256: sha ? sha.padStart(64, '0').slice(0, 64) : "0".repeat(64)
                  }
                }
              ]
            }
          };

          fs.writeFileSync(".artifacts/slsa_provenance_min.json", JSON.stringify(out));
          NODE

      - name: Verify SLSA provenance min (fail-closed)
        shell: bash
        run: |
          set -euo pipefail
          bash scripts/verify/verify_slsa_provenance_min.sh

      - name: Upload provenance artifact
        uses: actions/upload-artifact@v4
        with:
          name: slsa_provenance_min
          path: .artifacts/slsa_provenance_min.json

  attest_dsse:
    name: attest-dsse-provenance (main only)
    # main push에서만 DSSE attestation 생성/검증
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    needs: [provenance_min]
    env:
      GH_TOKEN: ${{ github.token }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare subject for attestation
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p .artifacts
          {
            echo "repo=${GITHUB_REPOSITORY}"
            echo "sha=${GITHUB_SHA}"
            echo "run_id=${GITHUB_RUN_ID}"
            echo "run_attempt=${GITHUB_RUN_ATTEMPT:-0}"
          } > .artifacts/supplychain_subject.txt

      # NOTE:
      # - PR/merge_group에서는 actions/attest* 다운로드 타임아웃으로 기준선이 흔들릴 수 있어 실행 금지
      # - main에서만 실행하여 supplychain 증빙을 유지
      - name: Generate DSSE provenance attestation (subject-path)
        uses: actions/attest-build-provenance@v3
        with:
          subject-path: .artifacts/supplychain_subject.txt

      # jq는 ubuntu-latest에 있는 경우가 많지만, 없을 수도 있어 main에서만 설치 허용
      - name: Install deps for verify (jq) (main only)
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y jq

      - name: Verify DSSE attestation (fail-closed) (main only)
        shell: bash
        run: |
          set -euo pipefail
          bash scripts/verify/verify_slsa_dsse_attestation.sh

  gate:
    name: gate
    runs-on: ubuntu-latest
    needs: [provenance_min, attest_dsse]
    steps:
      - name: Gate (PR/merge_group: provenance_min only, main: require DSSE)
        shell: bash
        run: |
          set -euo pipefail

          echo "provenance_min=${{ needs.provenance_min.result }}"
          echo "attest_dsse=${{ needs.attest_dsse.result }}"

          # 1) 항상 provenance_min은 성공해야 함
          if [ "${{ needs.provenance_min.result }}" != "success" ]; then
            echo "GATE:FAIL (provenance_min)"
            exit 1
          fi

          # 2) main push에서는 attest_dsse도 성공해야 함
          if [ "${{ github.event_name }}" = "push" ] && [ "${{ github.ref }}" = "refs/heads/main" ]; then
            if [ "${{ needs.attest_dsse.result }}" != "success" ]; then
              echo "GATE:FAIL (attest_dsse required on main)"
              exit 1
            fi
          fi

          echo "GATE:OK"
