# PREP_TOKEN=1
name: product-verify-onprem-proof-strict

on:
  pull_request:
  merge_group:
  workflow_dispatch:
  schedule:
    # Run weekly on Monday at 00:00 UTC
    - cron: '0 0 * * 1'

permissions:
  contents: read

jobs:
  onprem-proof-strict:
    name: onprem-proof-strict
    runs-on: self-hosted
    # Note: Add 'onprem' label if required by org policy
    # runs-on: [self-hosted, onprem]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install ripgrep
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y ripgrep jq

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Ops deps preflight (fail-closed)
        shell: bash
        run: |
          set -euo pipefail
          bash scripts/verify/verify_ops_deps.sh --require-node-npm --require-rg --require-jq

      - name: Build bff-accounting (preflight for P2-AI-01 verify)
        run: |
          cd webcore_appcore_starter_4_17/packages/bff-accounting
          npm ci
          npm run build

      - name: Create build stamp (DIST_FRESHNESS_POLICY_V1)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p webcore_appcore_starter_4_17/packages/bff-accounting/dist
          cat > webcore_appcore_starter_4_17/packages/bff-accounting/dist/.build_stamp.json <<EOF
          {"git_sha":"${GITHUB_SHA}","built_at_utc":"$(date -u +%Y-%m-%dT%H:%M:%SZ)","workflow_name":"${GITHUB_WORKFLOW}"}
          EOF
          test -s webcore_appcore_starter_4_17/packages/bff-accounting/dist/.build_stamp.json

      - name: Bootstrap web_e2e deps (node_modules)
        run: |
          set -euo pipefail
          cd webcore_appcore_starter_4_17/scripts/web_e2e
          npm ci

      - name: Install Playwright browsers
        run: |
          set -euo pipefail
          cd webcore_appcore_starter_4_17/scripts/web_e2e
          npx playwright install --with-deps
        env:
          PLAYWRIGHT_BROWSERS_PATH: ${{ runner.temp }}/ms-playwright

      - name: Run repo-wide guards with strict onprem proof (fail-closed)
        env:
          ONPREM_PROOF_STRICT_ENFORCE: "1"
        run: |
          bash scripts/verify/verify_repo_contracts.sh

  gate:
    runs-on: ubuntu-latest
    needs: [onprem-proof-strict]
    steps:
      - name: gate
        run: |
          if [ "${{ needs.onprem-proof-strict.result }}" != "success" ]; then
            echo "GATE:FAIL"
            exit 1
          fi
          echo "GATE:OK"

